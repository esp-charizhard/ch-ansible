- name: Setup cluster basic
  block:
    - name: create join_message.sh file
      file:
        path: "$HOME/join_message.sh"
        state: touch
    
    - name: Initialize kubeadm
      become: true
      shell: kubeadm init --config /tmp/kubeadm/kubeadm-config.yml >> ~/join_message.sh
      register: join_message
#      shell: kubeadm init --pod-network-cidr=10.244.0.0/16 --cri-socket=unix:///var/run/containerd/containerd.sock

    - name: create kube directory
      file:
        path: $HOME/.kube
        state: directory
        owner: root

    - name: copy admin.conf to .kube/config
      become: true
      shell: cat  /etc/kubernetes/admin.conf > $HOME/.kube/config

    - name: Run cluster by regular user
      become: true
      shell: chown $(id -u):$(id -g) $HOME/.kube/config

    - name: Ensure kubectl context uses the correct server address
      shell: |
        kubectl config set-cluster default --server=https://{{ ansible_host }}:6443 --kubeconfig=/home/papyrus/.kube/config
        kubectl config set-credentials kubernetes-admin --client-certificate=/etc/kubernetes/pki/apiserver.crt --client-key=/etc/kubernetes/pki/apiserver.key  --kubeconfig=/home/papyrus/.kube/config
        kubectl config set-context default --cluster=default --user=kubernetes-admin  --kubeconfig=/home/papyrus/.kube/config
        kubectl config use-context default  --kubeconfig=/home/papyrus/.kube/config
      delegate_to: "{{ inventory_hostname }}" # delegate to localhost
  
    - name: Set Up Pod Network
      become: true
      shell: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml --validate=false
  rescue:
  - name: Clean up kubernetes setup
    block:
      - name: Get logs
        become: true
        shell: cat ~/.kube/config
        register: caca

      - name: Show logs
        debug: var=caca
      
      - name: Reset kubeadm
        become: true
        shell: sudo kubeadm reset --cri-socket=unix:///var/run/containerd/containerd.sock -f
        register: reset_result
        failed_when: reset_result.rc != 0

      - name: Remove Docker directory
        become: true
        file:
          path: /var/lib/docker
          state: absent
        register: docker_dir_result
        failed_when: docker_dir_result.failed

      - name: Remove Kubernetes directory
        become: true
        file:
          path: /etc/kubernetes
          state: absent
        register: k8s_dir_result
        failed_when: k8s_dir_result.failed

    rescue:
      - name: Handle cleanup failure
        debug:
          msg: "Cleanup failed. Please manually inspect and clean up the system."

        

