---
- name: Create Kubernetes Deployment for charizhard-server
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'ch-server-deploy.yml.j2') }}"
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"

- name: Create charizhard-server Ingress
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: ch-wg-ingress
        namespace: default
        annotations:
          kubernetes.io/ingress.class: nginx
          nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
          cert-manager.io/cluster-issuer: cert-manager-webhook-duckdns-production
          nginx.ingress.kubernetes.io/use-regex: "true"
      spec:
        ingressClassName: nginx
        tls:
          - hosts:
              - '*.charizhard-wg.duckdns.org'
              - charizhard-wg.duckdns.org
            secretName: wg-tls-production
        rules:
          - host: '*.charizhard-wg.duckdns.org'
            http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: charizhard-server-service
                      port:
                        name: http
          - host: charizhard-wg.duckdns.org
            http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: charizhard-server-service
                      port:
                        name: http
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"